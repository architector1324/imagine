## ✨ Imagine: Легковесный API для генерации изображений с Stable Diffusion

![](logo.png)

*Изображение сгенерировано с помощью Imagine: "фото астронавта, едущего на лошади по Марсу, эпичное, кинематографичное, детализированное"*

**Imagine** - это простой, но мощный HTTP-сервер, разработанный для генерации изображений из текста **или других изображений** с использованием моделей Stable Diffusion и библиотеки `diffusers` от Hugging Face. Он предоставляет одну, понятную конечную точку, которая принимает JSON-запрос и возвращает сгенерированное изображение (или изображения) в виде Base64-кодированной строки (строк), что идеально подходит для быстрой интеграции в ваши приложения.

### Ключевые особенности

*   **Минималистичный API:** Одна простая в использовании конечная точка `/generate` для всех ваших потребностей в генерации изображений.
*   **Универсальная генерация:** Поддерживает как **преобразование текста в изображение (txt2img)**, так и **преобразование изображения в изображение (img2img)**.
*   **Потоковая передача прогресса в реальном времени:** Получайте обновления процесса генерации в реальном времени, передавая промежуточные шаги непосредственно клиенту.
*   **Вывод в Base64:** Удобно получайте сгенерированные изображения (как финальные, так и промежуточные шаги) в виде строк Base64, что позволяет легко встраивать их непосредственно в веб-страницы, мобильные приложения или другие сервисы, не управляя файловым хранилищем.
*   **Расширенные параметры:** Контролируйте параметры генерации изображений, такие как `width`, `height`, `num_steps`, `guidance_scale`, `sampler`, `seed`, `negative_prompt`, **входное изображение (`img`), сила диффузии (`strength`)**, а также **точность с плавающей запятой (`fp_prec`)** через JSON-полезную нагрузку и аргументы сервера.
*   **Поддержка автономного режима:** Запускайте генерацию изображений полностью в автономном режиме после загрузки моделей, что идеально подходит для локальных и безопасных развертываний.
*   **Создан на Flask и Diffusers:** Использует надежные и популярные библиотеки Python для обеспечения надежности и простоты использования.
*   **Независимость от аппаратного обеспечения:** Поддерживает CPU, CUDA (NVIDIA), MPS (Apple Silicon) и потенциально ROCm (AMD) в зависимости от вашей настройки PyTorch.

### Почему Imagine?

**Imagine** вдохновлен философией таких инструментов, как **Ollama**, и предлагает аналогичный подход, но для моделей Stable Diffusion. Он идеально подходит для разработчиков, которым требуется легковесное решение для запуска генерации изображений Stable Diffusion **как локального сервиса в фоновом режиме**.

Это позволяет вам интегрировать возможности генерации изображений **из любого места**: будь то скрипт командной строки, Python-приложение, веб-страница или любой другой сервис. **Благодаря поддержке автономного режима** вы можете обеспечить конфиденциальность и стабильную производительность. Вам больше не нужно беспокоиться о накладных расходах и сложности многофункциональных пользовательских интерфейсов; Imagine обеспечивает быстрый, API-ориентированный доступ к Stable Diffusion, разработанный для беспрепятственного развертывания и простого использования.


### Установка и использование

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/your-username/imagine.git
    cd imagine
    ```

2.  **Установите зависимости:**
    ```bash
    pip install torch diffusers transformers accelerate flask Pillow argparse requests base64
    ```
    (Для использования CUDA (NVIDIA GPU) убедитесь, что `torch` установлен правильно, например: `pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118`)

3.  **Укажите модель Stable Diffusion:**
    Отредактируйте `imagine.py` и установите `DEFAULT_MODEL` на путь к вашему файлу модели (`.safetensors` или `.ckpt`), например, `dreamshaper_8.safetensors`.

4.  **Настройте параметры сервера (Устройство, Точность):**
    Вместо изменения `imagine.py` вы можете настроить вычислительное устройство и точность с плавающей запятой непосредственно через аргументы командной строки при запуске сервера.
    *   `--device` или `-d`: Укажите `'cpu'`, `'cuda'` (для NVIDIA GPU) или `'mps'` (для Apple Silicon) для вычислений вашей модели. По умолчанию `'cpu'`.
    *   `--fp_prec` или `-f`: Установите точность с плавающей запятой на `16` (для `torch.float16`) или `32` (для `torch.float32`). `float16` может обеспечить более быстрый вывод и меньшее использование VRAM на совместимом оборудовании (например, NVIDIA GPU), но может повлиять на качество. По умолчанию `32`.

5.  **Запустите сервер:**
    ```bash
    python imagine.py --host '0.0.0.0' -p 5000 -d cuda -f 16 # Пример для CUDA с float16
    # python imagine.py # Запускается со значениями по умолчанию (cpu, float32)
    ```
    Сервер запустится по адресу `http://0.0.0.0:5000/`.

6.  **Отправьте POST-запрос на `/generate`:**

    Конечная точка `/generate` ожидает JSON-полезную нагрузку с вашими параметрами генерации. Ответ будет JSON-объектом, содержащим `img` (Base64-кодированный PNG) и `seed`. Если `stream` включен, он будет возвращать поток JSON-объектов.

    **Доступные параметры в JSON-полезной нагрузке:**
    *   `prompt` (строка, **обязательно**): Текстовый запрос для генерации изображения.
    *   `model` (строка, необязательно): Путь к файлу модели Stable Diffusion. По умолчанию используется `DEFAULT_MODEL`, установленный в `imagine.py`.
    *   `width` (целое число, необязательно): Ширина выходного изображения в пикселях. По умолчанию: `512`.
    *   `height` (целое число, необязательно): Высота выходного изображения в пикселях. По умолчанию: `512`.
    *   `num_steps` (целое число, необязательно): Количество шагов инференса. По умолчанию: `25`.
    *   `guidance` (число с плавающей запятой, необязательно): Масштаб CFG (classifier-free guidance). По умолчанию: `7.0`.
    *   `sampler` (строка, необязательно): Алгоритм сэмплера. Доступно: `'ddim'`, `'euler'`, `'euler a'`, `'heun'`, `'lms'`, `'dpm++ 2m'`, `'dpm++ 2s'`, `'dpm++ sde'`, `'dpm2'`, `'dpm2 a'`. По умолчанию: `'dpm++ 2m'`.
    *   `seed` (целое число, необязательно): Случайное начальное число для воспроизводимости. По умолчанию: случайное целое число.
    *   `neg` (строка, необязательно): Негативный запрос. По умолчанию: `''` (пустая строка).
    *   `img` (строка, необязательно): Base64-кодированное входное изображение (в формате URI данных, например, `data:image/png;base64,...`). Если указано, активирует режим `img2img`. По умолчанию: `None`.
    *   `strength` (число с плавающей запятой, необязательно): Сила денойзинга для режима `img2img` (от 0.0 до 1.0). Контролирует, насколько сильно изменяется изображение. По умолчанию: `0.8`.
    *   `stream` (целое число, необязательно): Если установлено целое число `N > 0`, промежуточные изображения будут передаваться потоком каждые `N` шагов в виде отдельных JSON-объектов. Если `null` или `0`, возвращается только финальное изображение. По умолчанию: `None`.

    ---

    **Пример: Базовое преобразование текста в изображение (txt2img)**
    ```bash
    curl -X POST -H "Content-Type: application/json" \
         -d '{
             "model": "/путь/к/вашей/dreamshaper_8.safetensors",
             "prompt": "фотография астронавта, скачущего на лошади по Марсу, эпично, кинематографично, детализированно",
             "width": 768,
             "height": 512,
             "num_steps": 25,
             "guidance": 7.0,
             "sampler": "dpm++ 2m",
             "seed": 12345,
             "neg": "уродливый, деформированный, размытый, низкое качество"
         }' \
         http://localhost:5000/generate | jq .
    ```
    В ответ вы получите JSON-объект, содержащий строку `img` и `seed`.

    ---

    **Пример: Преобразование изображения в изображение (img2img)**
    (Замените `<base64_encoded_image>` на ваши фактические данные изображения, закодированные в base64).
    ```bash
    echo '{
        "prompt": "футуристический город на закате, детализированный, неоновые огни",
        "img": "<base64_encoded_image>",
        "strength": 0.7,
        "width": 512,
        "height": 512,
        "sampler": "euler a",
        "num_steps": 30,
        "neg": "размытый, низкое качество"
    }' | curl -X POST -H "Content-Type: application/json" -d @- http://localhost:5000/generate | jq .
    ```

    ---

    **Пример: Потоковая передача промежуточных шагов**
    Это будет передавать несколько JSON-объектов. Каждый объект, кроме последнего, будет содержать `img` (промежуточный шаг). Последний объект будет содержать `img` завершенной генерации.
    ```bash
    curl -X POST -H "Content-Type: application/json" \
         -d '{
             "prompt": "кошка в крошечной шляпке, акварельная живопись",
             "width": 512,
             "height": 512,
             "num_steps": 25,
             "stream": 5
         }' \
         http://localhost:5000/generate
    # Для обработки этого вы можете использовать инструменты вроде `jq -nc --stream 'fromjson'` или обрабатывать в вашем коде.
    ```

### Imagine CLI

### Описание

Простой скрипт командной строки для генерации изображений на основе текстовой подсказки с использованием библиотеки `diffusers`.

### Использование

```
usage: imagine [-m MODEL] [-o OUTPUT] [-w WIDTH] [-h HEIGHT] [-n NUM_STEPS] [-g GUIDANCE] [-s SAMPLER] [--seed SEED] [--neg NEG] [--stream STREAM] [--help] prompt [prompt ...]

SD image generator

positional arguments:
  prompt                Prompt for model

options:
  -m, --model MODEL     SD model
  -o, --output OUTPUT   Output image
  -w, --width WIDTH     Output image width
  -h, --height HEIGHT   Output image height
  -n, --num_steps NUM_STEPS
                        Number of steps
  -g, --guidance GUIDANCE
                        Guidance scale
  -s, --sampler SAMPLER
                        SD Sampler ['DDIM', 'Euler', 'Euler a', 'Heun', 'LMS', 'DPM++ 2M', 'DPM++ 2S', 'DPM++ SDE', 'DPM2', 'DPM2 a']
  --seed SEED           Seed
  --neg NEG             Negative prompt
  --stream STREAM       Stream steps samples to output image
  --help
```

#### Пример использования

```bash
./imagine-cli.py 'фотография астронавта, скачущего на лошади по Марсу, эпично, кинематографично, детализированно' -w 768 -h 512 -n 25 -g 7.0 -s 'dpm++ 2m' --neg 'уродливый, деформированный, размытый, низкое качество'
```

### Вывод

Скрипт сохранит сгенерированное изображение в текущую директорию с именем файла, основанным на подсказке или временной метке.

## Расширенное развертывание: Запуск как служба Systemd

Для постоянной и надежной работы вы можете настроить **Imagine** как службу `systemd`. Это гарантирует, что сервер будет автоматически запускаться при загрузке и перезапускаться в случае сбоев.

**1. Создайте символические ссылки и убедитесь в исполняемости:**

Убедитесь, что как ваш серверный скрипт (`imagine.py`), так и утилита командной строки (`imagine-cli.py`) являются исполняемыми и имеют символические ссылки на общедоступную директорию `PATH`, такую как `/usr/bin/`.

```bash
# Сделайте скрипты исполняемыми
chmod +x /path/to/imagine/imagine.py
chmod +x /path/to/imagine/imagine-cli.py

# Создайте символические ссылки
# Замените `/path/to/imagine` на фактический путь к директории вашего проекта, если он отличается
sudo ln -s /path/to/imagine/imagine.py /usr/bin/imagine-server
sudo ln -s /path/to/imagine/imagine-cli.py /usr/bin/imagine
```

**2. Создайте файл службы Systemd:**

Создайте файл с именем `imagine.service` в `/etc/systemd/system/`:

```bash
sudo nano /etc/systemd/system/imagine.service
```

Вставьте следующее содержимое в файл:

```ini
[Unit]
Description=Imagine: Сервер генерации изображений Stable Diffusion
After=network.target syslog.target

[Service]
# ЗАМЕНИТЕ 'arch' НА ВАШЕ ИМЯ ПОЛЬЗОВАТЕЛЯ LINUX!
# Запускайте сервис от имени вашего текущего пользователя.
# Это упрощает управление разрешениями, так как скрипт и модель, вероятно, находятся в вашей домашней директории.
User=arch

# Команда для выполнения при запуске сервиса.
# Убедитесь, что /usr/bin/imagine-server указывает на ваш основной серверный скрипт (imagine.py).
ExecStart=/usr/bin/imagine-server

# Перезапускать сервис, если он аварийно завершится
Restart=on-failure
RestartSec=5s

# Стандартный вывод и ошибки будут направлены в журнал systemd для удобной отладки
StandardOutput=journal
StandardError=journal

# Тип сервиса: simple (по умолчанию) или forking
Type=simple

[Install]
# Этот юнит должен запускаться, когда система достигает состояния multi-user.target (нормальная загрузка)
WantedBy=multi-user.target
```

**Важные примечания:**
*   **Замените `arch` на ваше фактическое имя пользователя Linux!**
*   Убедитесь, что символическая ссылка `/usr/bin/imagine` корректно указывает на ваш **серверный скрипт** (`imagine.py`).

**3. Включите и запустите службу:**

После сохранения файла `imagine.service`:

```bash
# Перезагрузите systemd, чтобы он распознал новый сервис
sudo systemctl daemon-reload

# Включите сервис для автоматического запуска при загрузке
sudo systemctl enable imagine.service

# Запустите сервис немедленно
sudo systemctl start imagine.service
```

**4. Проверьте статус службы и логи:**

Чтобы проверить, что служба работает корректно:

```bash
sudo systemctl status imagine.service
```

Чтобы просмотреть логи в реальном времени для отладки:

```bash
journalctl -u imagine.service -f
```